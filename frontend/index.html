<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Insightra ¬∑ AI Research Assistant</title>

<style>
/* =========================================================
   Premium Enterprise UI - Advanced Answer Formatting
   - Natural, human-like presentation
   - Progressive disclosure
   - Visual hierarchy without AI patterns
========================================================= */

:root{
  --primary:#2563eb;
  --primary2:#1d4ed8;
  --accent:#7c3aed;
  --success:#059669;
  --warning:#d97706;
  --ink:#0f172a;
  --ink2:#1e293b;
  --muted:#64748b;
  --muted2:#94a3b8;

  --bg:#f8fafc;
  --panel:#ffffff;
  --panel2:#f1f5f9;
  --panel3:#e2e8f0;

  --border:#e2e8f0;
  --border2:#cbd5e1;

  --r4:4px;
  --r6:6px;
  --r8:8px;
  --r12:12px;
  --r16:16px;

  --shadow1: 0 1px 2px rgba(15,23,42,.05);
  --shadow2: 0 4px 16px rgba(15,23,42,.08);
  --shadow3: 0 12px 40px rgba(15,23,42,.12);

  --ease: cubic-bezier(.22,.68,0,1.1);
  --t1: 150ms var(--ease);
  --t2: 250ms var(--ease);
  --t3: 400ms var(--ease);

  --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  --mono: "JetBrains Mono", "Fira Code", Consolas, monospace;

  --safe-b: env(safe-area-inset-bottom, 0px);
  --safe-t: env(safe-area-inset-top, 0px);
}

*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family: var(--font);
  color: var(--ink);
  background: var(--bg);
  overflow:hidden;
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
}

@media (prefers-reduced-motion: reduce){
  *{animation:none!important;transition:none!important}
}

*{scrollbar-width: thin; scrollbar-color: var(--border2) transparent;}
*::-webkit-scrollbar{width:8px;height:8px}
*::-webkit-scrollbar-thumb{background:var(--border2);border-radius:999px}
*::-webkit-scrollbar-track{background:transparent}

.app{
  height:100vh;
  display:flex;
  overflow:hidden;
}

/* =========================================================
   Topbar
========================================================= */
.topbar{
  height:56px;
  background: var(--panel);
  border-bottom: 1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding: calc(8px + var(--safe-t)) 16px 8px;
  gap:12px;
  position: sticky;
  top: 0;
  z-index: 30;
}

.brand{
  display:flex;
  align-items:center;
  gap:12px;
  min-width: 200px;
}
.brand-badge{
  width:38px;height:38px;
  border-radius: var(--r8);
  background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  box-shadow: 0 4px 12px rgba(37,99,235,.25);
}
.brand-title{
  display:flex;
  flex-direction:column;
  line-height:1.1;
}
.brand-title strong{font-size:15px;font-weight:700;letter-spacing:-.3px}
.brand-title span{font-size:11px;color: var(--muted);margin-top:2px;font-weight:500}

.top-actions{
  display:flex;
  align-items:center;
  gap:8px;
}

.pill{
  height:32px;
  padding: 0 12px;
  border-radius: var(--r6);
  border: 1px solid var(--border);
  background: var(--panel2);
  color: var(--muted);
  font-size:12px;
  font-weight:600;
  display:flex;
  align-items:center;
  gap:6px;
}

.iconbtn{
  width:36px;height:36px;
  border-radius: var(--r6);
  border: 1px solid var(--border);
  background: var(--panel);
  cursor:pointer;
  transition: all var(--t1);
  display:flex;align-items:center;justify-content:center;
}
.iconbtn:hover{
  border-color: var(--primary);
  background: rgba(37,99,235,.05);
}
.iconbtn:active{transform: scale(.96)}
.iconbtn svg{width:18px;height:18px;color: var(--muted)}

/* =========================================================
   Sidebar
========================================================= */
.sidebar{
  width:320px;
  background: var(--panel);
  border-right: 1px solid var(--border);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

.sidebar-inner{
  display:flex;
  flex-direction:column;
  height:100%;
}

.sidebar-section{
  padding:16px;
  border-bottom: 1px solid var(--border);
}

.section-title{
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  color: var(--muted);
  font-weight:700;
  margin-bottom:12px;
}

.upload{
  border: 2px dashed var(--border2);
  background: var(--panel2);
  border-radius: var(--r8);
  padding: 16px;
  cursor:pointer;
  transition: all var(--t2);
}
.upload:hover{
  border-color: var(--primary);
  background: rgba(37,99,235,.03);
}
.upload:active{transform: scale(.99)}
.upload-row{
  display:flex;
  gap:12px;
  align-items:center;
}
.upload-ic{
  width:40px;height:40px;
  border-radius: var(--r8);
  background: linear-gradient(135deg, rgba(37,99,235,.12), rgba(124,58,237,.12));
  display:flex;align-items:center;justify-content:center;
  color: var(--primary);
}
.upload-ic svg{width:20px;height:20px}
.upload-txt b{display:block;font-size:14px;font-weight:600}
.upload-txt small{display:block;font-size:12px;color: var(--muted);margin-top:2px}

.row{display:flex;gap:8px;margin-top:12px}
.input{
  flex:1;height:40px;
  border-radius: var(--r6);
  border:1px solid var(--border);
  padding:0 12px;
  font-size:14px;
  outline:none;
  transition: all var(--t1);
  background: var(--panel);
}
.input:focus{
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(37,99,235,.1);
}

.btn{
  height:40px;
  padding:0 16px;
  border-radius: var(--r6);
  border: 1px solid var(--border);
  background: var(--panel);
  cursor:pointer;
  font-weight:600;
  font-size:13px;
  transition: all var(--t1);
  display:flex;align-items:center;justify-content:center;gap:6px;
}
.btn:hover{border-color: var(--primary); color: var(--primary)}
.btn:active{transform: scale(.98)}
.btn-primary{
  background: linear-gradient(135deg, var(--primary), var(--primary2));
  border-color: transparent;
  color:#fff;
  box-shadow: 0 2px 8px rgba(37,99,235,.3);
}
.btn-primary:hover{opacity:.9; border-color: transparent; color:#fff}

.sources{
  padding: 12px;
  overflow:auto;
  flex:1;
}
.source{
  display:flex;
  gap:10px;
  align-items:flex-start;
  padding: 10px 12px;
  border-radius: var(--r6);
  border: 1px solid transparent;
  transition: all var(--t1);
  background: var(--panel);
  margin-bottom:6px;
}
.source:hover{
  background: var(--panel2);
  border-color: var(--border);
}
.source input{margin-top:2px;width:16px;height:16px;accent-color: var(--primary)}
.source label{
  cursor:pointer;
  font-size:13px;
  color: var(--ink);
  line-height:1.4;
  word-break: break-word;
}
.source label small{
  display:block;
  color: var(--muted);
  font-weight:500;
  font-size:11px;
  margin-top:2px;
}

/* =========================================================
   Main Chat
========================================================= */
.main{
  flex:1;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  background: var(--bg);
}

.chat{
  flex:1;
  overflow:auto;
  padding: 20px;
}
.chat-inner{
  max-width: 900px;
  margin: 0 auto;
  padding-bottom: 180px;
}

/* Empty State */
.empty{
  min-height: 60vh;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  gap:16px;
  text-align:center;
  color: var(--muted);
  animation: fadeUp var(--t2) both;
}
@keyframes fadeUp{
  from{opacity:0; transform: translateY(12px)}
  to{opacity:1; transform: translateY(0)}
}
.empty .big{
  width:72px;height:72px;
  border-radius: var(--r12);
  background: var(--panel);
  border: 1px solid var(--border);
  box-shadow: var(--shadow2);
  display:flex;align-items:center;justify-content:center;
  font-size:32px;
}
.empty b{color: var(--ink); font-size:18px; font-weight:600}
.empty p{max-width: 420px; font-size:14px; line-height:1.7}

/* Messages */
.msg{
  display:flex;
  gap:14px;
  margin: 20px 0;
  animation: msgIn var(--t2) both;
}
@keyframes msgIn{
  from{opacity:0; transform: translateY(8px)}
  to{opacity:1; transform: translateY(0)}
}
.msg.user{justify-content:flex-end}

.avatar{
  width:36px;height:36px;
  border-radius: var(--r8);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  font-size:12px;
  flex: 0 0 36px;
  user-select:none;
}
.avatar.ai{
  color:#fff;
  background: linear-gradient(135deg, var(--primary), var(--accent));
}
.avatar.you{
  color:#fff;
  background: var(--ink);
}

.card{
  max-width: min(780px, 100%);
  border-radius: var(--r12);
  overflow:hidden;
  border: 1px solid var(--border);
  background: var(--panel);
  box-shadow: var(--shadow1);
}
.card.user{
  background: var(--ink);
  border-color: var(--ink);
}

.card-head{
  padding: 10px 14px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  border-bottom: 1px solid var(--border);
  background: var(--panel2);
}
.card.user .card-head{
  background: rgba(255,255,255,.05);
  border-bottom: 1px solid rgba(255,255,255,.1);
}
.meta{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:12px;
  font-weight:600;
  color: var(--muted);
}
.card.user .meta{color: rgba(255,255,255,.7)}
.dot{width:4px;height:4px;border-radius:999px;background: var(--muted2)}
.card.user .dot{background: rgba(255,255,255,.3)}

.tools{display:flex;align-items:center;gap:6px}
.sbtn{
  height:28px;
  padding:0 10px;
  border-radius: var(--r6);
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--muted);
  font-size:11px;
  font-weight:600;
  cursor:pointer;
  transition: all var(--t1);
}
.sbtn:hover{border-color: var(--primary); color: var(--primary)}
.sbtn:active{transform: scale(.96)}
.card.user .sbtn{
  background: rgba(255,255,255,.1);
  border-color: rgba(255,255,255,.2);
  color: rgba(255,255,255,.8);
}
.card.user .sbtn:hover{border-color: rgba(255,255,255,.4); color:#fff}

/* =========================================================
   ADVANCED ANSWER FORMATTING - Human-like, not AI-looking
========================================================= */
.card-body{
  padding: 0;
  font-size: 15px;
  line-height: 1.7;
  color: var(--ink);
}
.card.user .card-body{color:#fff; padding: 14px 16px}

/* Answer Container */
.answer-container{
  display:flex;
  flex-direction:column;
}

/* Quick Take - The headline insight */
.quick-take{
  padding: 16px 18px;
  background: linear-gradient(135deg, rgba(37,99,235,.04), rgba(124,58,237,.04));
  border-bottom: 1px solid var(--border);
  position:relative;
}
.quick-take::before{
  content:'';
  position:absolute;
  left:0;
  top:0;
  bottom:0;
  width:4px;
  background: linear-gradient(180deg, var(--primary), var(--accent));
  border-radius: 0 2px 2px 0;
}
.quick-take-label{
  font-size:10px;
  letter-spacing:.1em;
  text-transform:uppercase;
  color: var(--primary);
  font-weight:700;
  margin-bottom:8px;
  display:flex;
  align-items:center;
  gap:6px;
}
.quick-take-label::after{
  content:'';
  flex:1;
  height:1px;
  background: linear-gradient(90deg, var(--border), transparent);
}
.quick-take p{
  font-size:16px;
  font-weight:500;
  color: var(--ink);
  margin:0;
}

/* Findings Grid */
.findings{
  padding: 16px 18px;
  border-bottom: 1px solid var(--border);
}
.findings-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:14px;
}
.findings-label{
  font-size:10px;
  letter-spacing:.1em;
  text-transform:uppercase;
  color: var(--muted);
  font-weight:700;
  display:flex;
  align-items:center;
  gap:8px;
}
.findings-count{
  font-size:11px;
  background: var(--panel2);
  padding: 3px 8px;
  border-radius: var(--r4);
  color: var(--muted);
  font-weight:600;
}
.findings-grid{
  display:grid;
  gap:10px;
}
.finding-item{
  display:flex;
  gap:12px;
  padding: 12px 14px;
  background: var(--panel2);
  border-radius: var(--r8);
  border: 1px solid transparent;
  transition: all var(--t1);
}
.finding-item:hover{
  background: var(--panel);
  border-color: var(--border);
  transform: translateX(4px);
}
.finding-marker{
  width:24px;
  height:24px;
  border-radius: var(--r6);
  background: var(--panel);
  border: 1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
  font-weight:700;
  color: var(--primary);
  flex-shrink:0;
}
.finding-item:nth-child(2) .finding-marker{color: var(--accent)}
.finding-item:nth-child(3) .finding-marker{color: var(--success)}
.finding-item:nth-child(4) .finding-marker{color: var(--warning)}
.finding-content{
  flex:1;
  font-size:14px;
  color: var(--ink2);
  line-height:1.6;
}

/* Context Block - Additional details */
.context-block{
  padding: 16px 18px;
  background: var(--panel);
}
.context-label{
  font-size:10px;
  letter-spacing:.1em;
  text-transform:uppercase;
  color: var(--muted);
  font-weight:700;
  margin-bottom:12px;
  display:flex;
  align-items:center;
  gap:6px;
}
.context-content{
  font-size:14px;
  color: var(--ink2);
  line-height:1.75;
}
.context-content p{
  margin: 10px 0;
}
.context-content p:first-child{margin-top:0}
.context-content p:last-child{margin-bottom:0}

/* Inline Highlights */
.highlight{
  background: linear-gradient(120deg, rgba(37,99,235,.1) 0%, rgba(124,58,237,.1) 100%);
  padding: 1px 6px;
  border-radius: var(--r4);
  font-weight:500;
}

/* Code in answers */
.context-content code,
.finding-content code{
  font-family: var(--mono);
  font-size: 13px;
  padding: 2px 6px;
  border-radius: var(--r4);
  background: var(--panel2);
  border: 1px solid var(--border);
}

/* Code blocks */
.code-block{
  margin: 14px 0;
  border-radius: var(--r8);
  border: 1px solid var(--border);
  overflow:hidden;
}
.code-header{
  padding: 8px 12px;
  background: var(--panel2);
  border-bottom: 1px solid var(--border);
  font-size:11px;
  font-weight:600;
  color: var(--muted);
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.code-body{
  padding: 14px;
  background: var(--ink);
  overflow-x:auto;
}
.code-body code{
  font-family: var(--mono);
  font-size: 13px;
  color: #e2e8f0;
  background:none;
  border:none;
  padding:0;
}

/* Insight Callout */
.insight-callout{
  margin: 14px 18px;
  padding: 14px 16px;
  background: linear-gradient(135deg, rgba(5,150,105,.06), rgba(5,150,105,.02));
  border: 1px solid rgba(5,150,105,.2);
  border-radius: var(--r8);
  display:flex;
  gap:12px;
  align-items:flex-start;
}
.insight-icon{
  width:28px;
  height:28px;
  border-radius: var(--r6);
  background: rgba(5,150,105,.12);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
  flex-shrink:0;
}
.insight-text{
  font-size:14px;
  color: var(--ink2);
  line-height:1.6;
}
.insight-text strong{
  color: var(--success);
}

/* Followups */
.followups{
  padding: 14px 18px;
  border-top: 1px solid var(--border);
  background: var(--panel2);
}
.followups-label{
  font-size:10px;
  letter-spacing:.1em;
  text-transform:uppercase;
  color: var(--muted);
  font-weight:700;
  margin-bottom:10px;
  display:flex;
  align-items:center;
  gap:6px;
}
.pills{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.pillbtn{
  border: 1px solid var(--border);
  background: var(--panel);
  border-radius: var(--r6);
  padding: 8px 12px;
  font-size: 13px;
  font-weight:500;
  color: var(--ink2);
  cursor:pointer;
  transition: all var(--t1);
}
.pillbtn:hover{
  border-color: var(--primary);
  color: var(--primary);
  background: rgba(37,99,235,.03);
}
.pillbtn:active{transform: scale(.98)}

/* Sources */
.sources-block{
  padding: 14px 18px;
  border-top: 1px solid var(--border);
  background: linear-gradient(135deg, rgba(37,99,235,.03), transparent);
}
.sources-label{
  font-size:10px;
  letter-spacing:.1em;
  text-transform:uppercase;
  color: var(--primary);
  font-weight:700;
  margin-bottom:10px;
  display:flex;
  align-items:center;
  gap:6px;
}
.source-link{
  display:flex;
  align-items:center;
  gap:10px;
  text-decoration:none;
  color: var(--ink);
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--r6);
  padding: 10px 12px;
  margin-top: 8px;
  transition: all var(--t1);
  font-size:13px;
  font-weight:500;
}
.source-link:first-of-type{margin-top:0}
.source-link:hover{
  border-color: var(--primary);
  transform: translateX(4px);
}
.source-link::before{
  content:'‚Üó';
  font-size:14px;
  color: var(--primary);
}

/* Typing Indicator */
.typing{
  display:flex;
  align-items:center;
  gap:12px;
  padding: 14px 16px;
  border-radius: var(--r8);
  border: 1px solid var(--border);
  background: var(--panel);
  width: fit-content;
  margin: 16px 0;
  box-shadow: var(--shadow1);
}
.dots{display:flex;gap:4px}
.dotb{
  width:6px;height:6px;border-radius:999px;
  background: var(--muted2);
  animation: bounce 1.2s infinite;
}
.dotb:nth-child(2){animation-delay:.15s}
.dotb:nth-child(3){animation-delay:.3s}
@keyframes bounce{0%,80%,100%{transform: translateY(0)}40%{transform: translateY(-6px)}}
.typing span{font-size:13px;color: var(--muted);font-weight:500}

/* =========================================================
   Composer
========================================================= */
.composer{
  position: fixed;
  left: 320px;
  right: 0;
  bottom: 0;
  padding: 12px 20px calc(12px + var(--safe-b));
  background: rgba(248,250,252,.95);
  border-top: 1px solid var(--border);
  backdrop-filter: blur(12px);
  z-index: 25;
}
.composer-inner{
  max-width: 900px;
  margin: 0 auto;
}
.textarea{
  width:100%;
  min-height: 48px;
  max-height: 180px;
  border-radius: var(--r8);
  border: 1px solid var(--border);
  padding: 12px 14px;
  outline:none;
  font-size: 15px;
  line-height:1.5;
  resize:none;
  background: var(--panel);
  transition: all var(--t1);
}
.textarea:focus{
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(37,99,235,.08);
}
.composer-row{
  margin-top:10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}
.check{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:13px;
  color: var(--muted);
  font-weight:500;
  cursor:pointer;
}
.check input{width:16px;height:16px;accent-color: var(--primary)}
.rightopt{display:flex;gap:8px;align-items:center}

#webLensBtn{
  position: fixed;
  right: 20px;
  bottom: calc(100px + var(--safe-b));
  height:40px;
  padding:0 14px;
  border-radius: var(--r8);
  border: 0;
  background: var(--ink);
  color:#fff;
  font-weight:600;
  font-size:13px;
  cursor:pointer;
  transition: all var(--t1);
  display:flex;
  align-items:center;
  gap:8px;
  z-index: 40;
  box-shadow: var(--shadow2);
}
#webLensBtn:hover{transform: translateY(-2px); box-shadow: var(--shadow3)}
#webLensBtn:active{transform: translateY(0)}

.overlay{
  position: fixed;
  inset:0;
  background: rgba(15,23,42,.5);
  opacity:0;
  pointer-events:none;
  transition: opacity var(--t2);
  z-index: 50;
  backdrop-filter: blur(2px);
}
.overlay.show{opacity:1;pointer-events:auto}

@media (max-width: 980px){
  .sidebar{
    position: fixed;
    top:0; bottom:0;
    left: -340px;
    width: 320px;
    z-index: 60;
    box-shadow: var(--shadow3);
    transition: left var(--t2);
  }
  .sidebar.open{left:0}
  .composer{left:0}
  .brand{min-width:auto}
}

@media (max-width: 480px){
  .sidebar{width: 90vw}
  .pill{display:none}
  .chat{padding:14px}
}

.toast{
  position: fixed;
  left: 50%;
  bottom: calc(20px + var(--safe-b));
  transform: translateX(-50%) translateY(8px);
  background: var(--ink);
  color:#fff;
  padding: 10px 16px;
  border-radius: var(--r8);
  font-weight:600;
  font-size:13px;
  opacity:0;
  pointer-events:none;
  transition: all var(--t2);
  z-index: 80;
  box-shadow: var(--shadow2);
}
.toast.show{opacity:1; transform: translateX(-50%) translateY(0)}
</style>
</head>

<body>

<div class="app">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-inner">
      <div class="sidebar-section">
        <div class="section-title">Data Sources</div>

        <div class="upload" onclick="document.getElementById('fileInput').click()" role="button" tabindex="0">
          <div class="upload-row">
            <div class="upload-ic">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 16V4m0 0L7 9m5-5l5 5M4 20h16"/>
              </svg>
            </div>
            <div class="upload-txt">
              <b>Upload Document</b>
              <small>PDF, TXT, DOC, DOCX</small>
            </div>
          </div>
        </div>

        <input type="file" id="fileInput" style="display:none" accept=".pdf,.txt,.doc,.docx">

        <div class="row">
          <input class="input" id="urlInput" type="text" placeholder="Paste URL here..." autocomplete="off">
          <button class="btn" onclick="addURL()">Add</button>
        </div>
      </div>

      <div class="sources" id="sources"></div>
    </div>
  </aside>

  <main class="main">
    <header class="topbar">
      <div class="brand">
        <div class="brand-badge">üîç</div>
        <div class="brand-title">
          <strong>Insightra</strong>
          <span>Research Assistant</span>
        </div>
      </div>

      <div class="top-actions">
        <div class="pill" id="srcCount">0 sources</div>

        <button class="iconbtn" id="sidebarToggle" title="Sources">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>

        <button class="iconbtn" onclick="scrollToBottom(true)" title="Scroll down">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7-7-7M12 21V3"/>
          </svg>
        </button>
      </div>
    </header>

    <section class="chat" id="chat">
      <div class="chat-inner" id="chatInner">
        <div class="empty" id="emptyState">
          <div class="big">üí¨</div>
          <b>Start your research</b>
          <p>Upload sources and ask questions. Get clear, organized answers with key findings highlighted.</p>
        </div>
      </div>
    </section>

    <footer class="composer">
      <div class="composer-inner">
        <textarea id="query" class="textarea" rows="2" placeholder="Ask anything about your sources..."></textarea>

        <div class="composer-row">
          <label class="check">
            <input type="checkbox" id="compareMode">
            Compare Mode
          </label>

          <div class="rightopt">
            <button class="btn" onclick="switchLens()">‚ú® Insight</button>
            <button class="btn btn-primary" onclick="ask()">Send</button>
          </div>
        </div>
      </div>
    </footer>
  </main>

  <div class="overlay" id="overlay" onclick="closeSidebar()"></div>
</div>

<div class="toast" id="toast">Done</div>

<script>
const chat = document.getElementById("chat");
const chatInner = document.getElementById("chatInner");
const query = document.getElementById("query");
const sources = document.getElementById("sources");
const urlInput = document.getElementById("urlInput");
const fileInput = document.getElementById("fileInput");
const compareMode = document.getElementById("compareMode");

const sidebar = document.getElementById("sidebar");
const overlay = document.getElementById("overlay");
const sidebarToggle = document.getElementById("sidebarToggle");
const toast = document.getElementById("toast");
const srcCount = document.getElementById("srcCount");
const emptyState = document.getElementById("emptyState");

let selectedText = "";

function isMobile(){ return window.matchMedia("(max-width: 980px)").matches; }
function openSidebar(){ sidebar.classList.add("open"); overlay.classList.add("show"); }
function closeSidebar(){ sidebar.classList.remove("open"); overlay.classList.remove("show"); }

sidebarToggle.addEventListener("click", () => {
  if (!isMobile()) return;
  sidebar.classList.contains("open") ? closeSidebar() : openSidebar();
});

window.addEventListener("resize", () => { if (!isMobile()) closeSidebar(); });
document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeSidebar(); });

function showToast(text){
  toast.textContent = text || "Done";
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), 1200);
}

function scrollToBottom(smooth=false){
  if (smooth) chat.scrollTo({top: chat.scrollHeight, behavior:"smooth"});
  else chat.scrollTop = chat.scrollHeight;
}

function escapeHTML(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function normalizeText(text){
  let t = String(text ?? "");
  t = t.replace(/([a-zA-Z\)\]])(\d+)\.(\S)/g, "$1\n$2. $3");
  t = t.replace(/(\d+)\.(\S)/g, "$1. $2");
  t = t.replace(/[ \t]{2,}/g, " ");
  return t.trim();
}

function timeStr(){
  return new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
}

/* =========================================================
   ADVANCED ANSWER BUILDER - Human-like formatting
========================================================= */

function extractSentences(text){
  return text.split(/(?<=[.!?])\s+/).map(s => s.trim()).filter(s => s.length > 10);
}

function extractListItems(text){
  const lines = text.split("\n");
  const items = [];
  for (const line of lines){
    const l = line.trim();
    const mOL = l.match(/^(\d+)\.\s+(.*)$/);
    const mUL = l.match(/^\-\s+(.*)$/);
    if (mOL) items.push(mOL[2]);
    else if (mUL) items.push(mUL[1]);
  }
  return items;
}

function buildAdvancedAnswer(rawText){
  const text = normalizeText(rawText);
  if (!text) return '<div class="answer-container"><div class="context-block"><div class="context-content"><p>No response available.</p></div></div></div>';

  const paragraphs = text.split(/\n\s*\n/).map(p => p.trim()).filter(Boolean);
  const sentences = extractSentences(text);
  const listItems = extractListItems(text);
  
  let html = '<div class="answer-container">';

  // Quick Take - First meaningful sentence or short paragraph
  let quickTake = "";
  if (paragraphs.length > 0){
    const firstPara = paragraphs[0];
    if (firstPara.length < 300){
      quickTake = firstPara;
    } else {
      const firstSentences = extractSentences(firstPara);
      quickTake = firstSentences.slice(0,2).join(" ");
    }
  }

  if (quickTake){
    html += `
      <div class="quick-take">
        <div class="quick-take-label">Quick Take</div>
        <p>${escapeHTML(quickTake)}</p>
      </div>
    `;
  }

  // Findings - Extract key points
  let findings = [];
  if (listItems.length >= 2){
    findings = listItems.slice(0, 6);
  } else if (sentences.length >= 3){
    // Pick diverse sentences as findings
    const usedIndexes = new Set();
    const step = Math.max(1, Math.floor(sentences.length / 5));
    for (let i = 1; i < sentences.length && findings.length < 5; i += step){
      if (!usedIndexes.has(i) && sentences[i].length > 30 && sentences[i].length < 250){
        findings.push(sentences[i]);
        usedIndexes.add(i);
      }
    }
  }

  if (findings.length >= 2){
    html += `
      <div class="findings">
        <div class="findings-header">
          <div class="findings-label">Key Findings</div>
          <div class="findings-count">${findings.length} points</div>
        </div>
        <div class="findings-grid">
          ${findings.map((f, i) => `
            <div class="finding-item">
              <div class="finding-marker">${i + 1}</div>
              <div class="finding-content">${escapeHTML(f)}</div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  // Context/Details - Remaining content
  const remainingParas = paragraphs.slice(1);
  if (remainingParas.length > 0 || (paragraphs.length === 1 && !findings.length)){
    const detailText = remainingParas.length > 0 ? remainingParas : paragraphs;
    
    html += `
      <div class="context-block">
        <div class="context-label">Details</div>
        <div class="context-content">
          ${detailText.map(p => {
            // Check for code blocks
            if (p.includes('```')){
              const parts = p.split('```');
              return parts.map((part, i) => {
                if (i % 2 === 1){
                  return `<div class="code-block"><div class="code-header">Code</div><div class="code-body"><code>${escapeHTML(part.trim())}</code></div></div>`;
                }
                return part.trim() ? `<p>${escapeHTML(part.trim())}</p>` : '';
              }).join('');
            }
            return `<p>${escapeHTML(p)}</p>`;
          }).join('')}
        </div>
      </div>
    `;
  }

  // Add insight callout if text is substantial
  if (text.length > 500){
    const insightSentence = sentences.find(s => 
      s.toLowerCase().includes('important') || 
      s.toLowerCase().includes('key') ||
      s.toLowerCase().includes('note') ||
      s.toLowerCase().includes('significant')
    );
    
    if (insightSentence){
      html += `
        <div class="insight-callout">
          <div class="insight-icon">üí°</div>
          <div class="insight-text"><strong>Worth noting:</strong> ${escapeHTML(insightSentence)}</div>
        </div>
      `;
    }
  }

  html += '</div>';
  return html;
}

function buildSimpleHTML(text){
  const normalized = normalizeText(text);
  const lines = normalized.split("\n");
  let html = "";
  
  for (const line of lines){
    const l = line.trim();
    if (!l) continue;
    html += `<p>${escapeHTML(l)}</p>`;
  }
  
  return html || "<p></p>";
}

/* =========================================================
   Chat Rendering
========================================================= */
function clearEmpty(){ if (emptyState) emptyState.remove(); }

function createMessage(role, text="", {advanced=false} = {}){
  clearEmpty();

  const wrap = document.createElement("div");
  wrap.className = `msg ${role==="user" ? "user" : ""}`;

  const avatar = document.createElement("div");
  avatar.className = `avatar ${role==="user" ? "you" : "ai"}`;
  avatar.textContent = role==="user" ? "You" : "AI";

  const card = document.createElement("div");
  card.className = `card ${role==="user" ? "user" : ""}`;

  const head = document.createElement("div");
  head.className = "card-head";
  head.innerHTML = `
    <div class="meta">
      <span>${role==="user" ? "You" : "Assistant"}</span>
      <span class="dot"></span>
      <span>${timeStr()}</span>
    </div>
    <div class="tools">
      ${role==="user" ? "" : `<button class="sbtn" data-copy="1">Copy</button>`}
    </div>
  `;

  const body = document.createElement("div");
  body.className = "card-body";
  
  if (role === "user"){
    body.innerHTML = buildSimpleHTML(text);
  } else {
    body.innerHTML = advanced ? buildAdvancedAnswer(text) : '<div class="answer-container"></div>';
  }

  card.appendChild(head);
  card.appendChild(body);

  if (role==="user"){ wrap.appendChild(card); wrap.appendChild(avatar); }
  else { wrap.appendChild(avatar); wrap.appendChild(card); }

  const copyBtn = head.querySelector("[data-copy]");
  if (copyBtn){
    copyBtn.addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(body.innerText);
        showToast("Copied");
      }catch{
        showToast("Failed");
      }
    });
  }

  chatInner.appendChild(wrap);
  scrollToBottom(false);

  return { bodyEl: body, cardEl: card };
}

function showTyping(){
  const t = document.createElement("div");
  t.className = "typing";
  t.innerHTML = `
    <div class="dots">
      <div class="dotb"></div><div class="dotb"></div><div class="dotb"></div>
    </div>
    <span>Thinking...</span>
  `;
  chatInner.appendChild(t);
  scrollToBottom(false);
  return t;
}

function renderFollowups(cardEl, questions){
  if (!Array.isArray(questions) || !questions.length) return;

  const old = cardEl.querySelector(".followups");
  if (old) old.remove();

  const box = document.createElement("div");
  box.className = "followups";
  box.innerHTML = `<div class="followups-label">Related Questions</div><div class="pills"></div>`;
  const pills = box.querySelector(".pills");

  questions.forEach(q=>{
    const b = document.createElement("button");
    b.className = "pillbtn";
    b.textContent = q;
    b.onclick = ()=>{ query.value = q; autoResize(); ask(); };
    pills.appendChild(b);
  });

  cardEl.querySelector(".card-body").appendChild(box);
  scrollToBottom(false);
}

function renderSources(cardEl, srcs){
  const container = cardEl.querySelector(".card-body .answer-container") || cardEl.querySelector(".card-body");
  const old = container.querySelector(".sources-block");
  if (old) old.remove();

  const box = document.createElement("div");
  box.className = "sources-block";
  box.innerHTML = `<div class="sources-label">Sources</div>`;

  srcs.forEach(s=>{
    const a = document.createElement("a");
    a.className = "source-link";
    a.href = s.url;
    a.target = "_blank";
    a.rel = "noreferrer";
    a.textContent = s.title || s.url;
    box.appendChild(a);
  });

  container.appendChild(box);
  scrollToBottom(false);
}

function updateSourceCount(){
  const selected = document.querySelectorAll("#sources input[type=checkbox]:checked").length;
  srcCount.textContent = `${selected} source${selected===1?"":"s"}`;
}
document.addEventListener("change", (e)=>{
  if (e.target && e.target.matches("#sources input[type=checkbox]")) updateSourceCount();
});

fileInput.addEventListener("change", ()=>{ if (fileInput.files[0]) uploadFile(); });

function addSource(source){
  const item = document.createElement("div");
  item.className = "source";
  const sid = String(source.source_id);

  item.innerHTML = `
    <input type="checkbox" id="src-${escapeHTML(sid)}" value="${escapeHTML(sid)}" checked>
    <label for="src-${escapeHTML(sid)}">
      ${escapeHTML(source.name)}
      <small>Active</small>
    </label>
  `;
  sources.appendChild(item);
  updateSourceCount();
}

function uploadFile(){
  const file = fileInput.files[0];
  if (!file) return;

  const temp = document.createElement("div");
  temp.className = "source";
  temp.innerHTML = `<label>Uploading... <small>${escapeHTML(file.name)}</small></label>`;
  sources.appendChild(temp);

  const fd = new FormData();
  fd.append("file", file);

  fetch("/upload", {method:"POST", body: fd})
    .then(r=>r.json())
    .then(source=>{
      temp.remove();
      addSource(source);
      if (isMobile()) closeSidebar();
      showToast("Uploaded");
    })
    .catch(()=>{
      temp.innerHTML = `<label>Failed <small>${escapeHTML(file.name)}</small></label>`;
      setTimeout(()=>temp.remove(), 2500);
    });
}

function addURL(){
  const url = urlInput.value.trim();
  if (!url) return;

  const temp = document.createElement("div");
  temp.className = "source";
  temp.innerHTML = `<label>Adding... <small>${escapeHTML(url)}</small></label>`;
  sources.appendChild(temp);

  const fd = new FormData();
  fd.append("url", url);

  fetch("/add_url", {method:"POST", body: fd})
    .then(r=>r.json())
    .then(source=>{
      temp.remove();
      addSource(source);
      urlInput.value = "";
      if (isMobile()) closeSidebar();
      showToast("Added");
    })
    .catch(()=>{
      temp.innerHTML = `<label>Failed <small>${escapeHTML(url)}</small></label>`;
      setTimeout(()=>temp.remove(), 2500);
    });
}

async function ask(){
  const question = query.value.trim();
  if (!question) return;

  const selectedSources = [...document.querySelectorAll("#sources input[type=checkbox]:checked")].map(x=>x.value);

  createMessage("user", question);
  query.value = "";
  autoResize();

  if (compareMode.checked){
    runCompare(question, selectedSources);
    return;
  }

  const typingEl = showTyping();
  const bot = createMessage("bot", "", {advanced:true});
  let fullText = "";

  const fd = new FormData();
  fd.append("query", question);
  fd.append("sources", selectedSources.join(","));

  try{
    const response = await fetch("/ask", {method:"POST", body: fd});
    const reader = response.body.getReader();
    const decoder = new TextDecoder();

    typingEl.remove();

    while(true){
      const {done, value} = await reader.read();
      if(done) break;

      const chunk = decoder.decode(value);
      const lines = chunk.split("\n").filter(Boolean);

      for(const line of lines){
        try{
          const msg = JSON.parse(line);
          if (msg.type === "answer"){
            fullText += msg.content;
            bot.bodyEl.innerHTML = buildAdvancedAnswer(fullText);
            scrollToBottom(false);
          }
          if (msg.type === "followups"){
            renderFollowups(bot.cardEl, msg.content);
          }
        }catch(e){
          console.error("Parse error", e);
        }
      }
    }
  }catch(err){
    try{ typingEl.remove(); }catch{}
    bot.bodyEl.innerHTML = '<div class="answer-container"><div class="context-block"><div class="context-content"><p>Something went wrong. Please try again.</p></div></div></div>';
    console.error(err);
  }
}

async function switchLens(){
  const question = query.value.trim();
  if (!question) return;

  createMessage("user", question);
  query.value = "";
  autoResize();

  const typingEl = showTyping();
  const bot = createMessage("bot", "", {advanced:true});

  const fd = new FormData();
  fd.append("query", question);

  try{
    const response = await fetch("/insight_lens", {method:"POST", body: fd});
    const data = await response.json();
    typingEl.remove();

    bot.bodyEl.innerHTML = buildAdvancedAnswer(data.answer || "");

    if (data.sources?.length){
      renderSources(bot.cardEl, data.sources);
    }
  }catch(err){
    try{ typingEl.remove(); }catch{}
    bot.bodyEl.innerHTML = '<div class="answer-container"><div class="context-block"><div class="context-content"><p>Failed to connect. Please try again.</p></div></div></div>';
    console.error(err);
  }
}

document.addEventListener("mouseup", ()=>{
  const selection = window.getSelection().toString().trim();
  const existingBtn = document.getElementById("webLensBtn");

  if (selection.length > 5){
    selectedText = selection;
    if (!existingBtn){
      const btn = document.createElement("button");
      btn.id = "webLensBtn";
      btn.innerHTML = "üîç Web Search";
      btn.onclick = runWebLens;
      document.body.appendChild(btn);
    }
  } else {
    if (existingBtn) existingBtn.remove();
  }
});

async function runWebLens(){
  const btn = document.getElementById("webLensBtn");
  if (btn) btn.remove();

  const typingEl = showTyping();
  const bot = createMessage("bot", "", {advanced:true});

  const fd = new FormData();
  fd.append("text", selectedText);

  try{
    const response = await fetch("/text_web_lens", {method:"POST", body: fd});
    const data = await response.json();
    typingEl.remove();

    bot.bodyEl.innerHTML = buildAdvancedAnswer(data.answer || "");
    if (data.sources?.length) renderSources(bot.cardEl, data.sources);
  }catch(err){
    try{ typingEl.remove(); }catch{}
    bot.bodyEl.innerHTML = '<div class="answer-container"><div class="context-block"><div class="context-content"><p>Search failed. Please try again.</p></div></div></div>';
    console.error(err);
  }
}

async function runCompare(queryText, sourceIds){
  const typingEl = showTyping();
  const bot = createMessage("bot", "");

  const fd = new FormData();
  fd.append("query", queryText);
  fd.append("sources", sourceIds.join(","));

  try{
    const response = await fetch("/compare", {method:"POST", body: fd});
    const data = await response.json();
    typingEl.remove();

    const names = Object.keys(data || {});
    const rows = names.map(n => String(data[n] || "").split("\n").filter(x => x.trim()));

    let html = `<div style="overflow:auto;border:1px solid var(--border);border-radius:var(--r8);background:var(--panel)">`;
    html += `<table style="width:100%;border-collapse:collapse;font-size:14px">`;
    html += `<tr>`;
    names.forEach(n => html += `<th style="position:sticky;top:0;background:var(--panel2);border-bottom:1px solid var(--border);padding:12px;text-align:left;font-weight:600">${escapeHTML(n)}</th>`);
    html += `</tr>`;

    const max = Math.max(0, ...rows.map(r => r.length));
    for (let i=0;i<max;i++){
      html += `<tr>`;
      rows.forEach(r => html += `<td style="border-top:1px solid var(--border);padding:12px;vertical-align:top;color:var(--ink2)">${escapeHTML(r[i] || "")}</td>`);
      html += `</tr>`;
    }
    html += `</table></div>`;

    bot.bodyEl.innerHTML = html;
  }catch(err){
    try{ typingEl.remove(); }catch{}
    bot.bodyEl.innerHTML = "<p>Comparison failed. Please try again.</p>";
    console.error(err);
  }
}

function autoResize(){
  query.style.height = "auto";
  query.style.height = Math.min(query.scrollHeight, 180) + "px";
}
query.addEventListener("input", autoResize);

query.addEventListener("keydown", (e)=>{
  if (e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    ask();
  }
});

updateSourceCount();
query.focus();
</script>

</body>
</html>